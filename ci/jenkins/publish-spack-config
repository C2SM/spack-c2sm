pipeline {
    agent {label 'dom' }
    stages {
        stage('Concat latest yaml-config and publish') {
            steps {
                sh """
                module load daint-gpu cray-python spack-config
                module unload cray-libsci/20.09.1
                python -m venv .venv
                source ./.venv/bin/activate
                pip install ruamel.yaml
                python ./ci/scripts/concat_yaml.py -m dom --publish_to_git
                """
            }
        }
        stage('Test packages') {
            steps {
                sh """
                module load cray-python
                module unload cray-libsci/20.09.1
                python ./ci/scripts/test_spack.py launch jenkins --dom --exclusive infero
                """
            }
        }
    }
    post {
        always {
            echo 'Cleaning up workspace'
            deleteDir() 
        }
        failure {
            mail bcc: '', body: '', cc: '', from: '', replyTo: '', subject: ' Build failed in Jenkins: publish-spack-config', to: 'jonas.jucker@c2sm.ethz.ch'
        }
    }
}
