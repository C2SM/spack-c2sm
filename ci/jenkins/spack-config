pipeline {
    agent {label 'dom'}
    stages {
        stage('Concat latest yaml-config') {
            agent { label 'dom' } 
            steps {
                sh """
                module load daint-gpu cray-python spack-config
                module unload cray-libsci/20.09.1
                python -m venv .venv
                source ./.venv/bin/activate
                pip install ruamel.yaml
                python ./ci/scripts/concat_yaml.py -m 'dom'
                rm -rf spack
                module unload spack-config
                """
            }
        }
        stage('Install dummy package') {
            steps {
                sh """
                module load cray-python
                module unload cray-libsci/20.09.1
                python ./ci/scripts/test_spack.py launch jenkins --dom --exclusive infero
                """
            }
        }
        stage('Test packages') {
            parallel {
                stage('cosmo') {
                    steps {
                        sh """
                        module load cray-python
                        module unload cray-libsci/20.09.1
                        python ./ci/scripts/test_spack.py launch jenkins --dom --exclusive cosmo
                        """
                    }
                }
                stage('int2lm') {
                    steps {
                        sh """
                        sleep 5
                        module load cray-python
                        module unload cray-libsci/20.09.1
                        python ./ci/scripts/test_spack.py launch jenkins --dom --exclusive int2lm
                        """
                    }
                }
                stage('icon') {
                    steps {
                        sh """
                        sleep 10
                        module load cray-python
                        module unload cray-libsci/20.09.1
                        python ./ci/scripts/test_spack.py launch jenkins --dom --exclusive icon
                        """
                    }
                }
                stage('icontools') {
                    steps {
                        sh """
                        sleep 20
                        module load cray-python
                        module unload cray-libsci/20.09.1
                        python ./ci/scripts/test_spack.py launch jenkins --dom --exclusive icontools
                        """
                    }
                }
            }
        }
    }
    post {
        always {
            archiveArtifacts artifacts: '*.log', allowEmptyArchive: true
            echo 'Cleaning up workspace'
            deleteDir() 
        }
        success {
            steps {
                build job: 'publish-spack-config'
            }
        }
        failure {
            echo 'Sending emails'
            mail bcc: '', body: 'spack-config failed', cc: '', from: '', replyTo: '', subject: ' Build failed in Jenkins: spack-config', to: 'jonas.jucker@c2sm.ethz.ch michael.jaehn@c2sm.ethz.ch'
        }
    }
}
