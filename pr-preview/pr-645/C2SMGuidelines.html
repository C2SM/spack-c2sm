<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>C2SM Guidelines for Spack &mdash; C2SM Spack  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="How to manage your own Spack instance" href="InstanceManagement.html" />
    <link rel="prev" title="Quick Start" href="QuickStart.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            C2SM Spack
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="QuickStart.html">Quick Start</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">C2SM Guidelines for Spack</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#building">Building</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#spack-install-c2sm-guidelines">Spack install (C2SM Guidelines)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spack-dev-build-c2sm-guidelines">Spack dev-build (C2SM Guidelines)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#running">Running</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#load-run-environment-of-a-package">Load run-environment of a package</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#spack-in-scripts">Spack in scripts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="InstanceManagement.html">How to manage your own Spack instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="SpackCommands.html">Important Spack Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="Testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="CodeDevelopment.html">Develop packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="SpackChoice.html">Why was spack chosen by MeteoSwiss?</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">C2SM Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">C2SM Guidelines for Spack</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/C2SMGuidelines.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="c2sm-guidelines-for-spack">
<h1>C2SM Guidelines for Spack<a class="headerlink" href="#c2sm-guidelines-for-spack" title="Permalink to this heading"></a></h1>
<p>Spack enables users to install software in a very user-friendly way,
for example by allowing different versions or specifications
of the same package to be installed simultaneously, or installing
without having to “manually” download the source code. This comes at
the expense of potentially losing control over the exact
version/specification being installed. For this reason, C2SM has
the following guidelines for building, running and installing your
libraries and executables.</p>
<section id="building">
<h2>Building<a class="headerlink" href="#building" title="Permalink to this heading"></a></h2>
<p>There are two possible ways of building software with Spack.
<em>spack install</em> and  <em>spack dev-build</em>.
Both of them are fine, but have some specialties one needs to take
into account.</p>
<section id="spack-install-c2sm-guidelines">
<h3>Spack install (C2SM Guidelines)<a class="headerlink" href="#spack-install-c2sm-guidelines" title="Permalink to this heading"></a></h3>
<p>Every <em>spack-install</em> needs a version suffix, i.e <em>spack install &lt;package&gt;&#64;&lt;version-suffix&gt;</em>.
This version-suffix can have different meanings:</p>
<ul class="simple">
<li><p>branch in the git repository</p></li>
<li><p>one out of several git repositories defined in the package</p></li>
<li><p>a specifc version (git-tag) with a corresponding git-hash hardcoded in the package</p></li>
</ul>
<p>Only for the last item in the list above you will always fetch and
compile the same code.  The two other items can lead to different
codes in case the <em>HEAD</em> of this specific branch/repository got some
additional commits in the meantime.</p>
<p>Especially for production it is very important to now which version of a code is actually used.</p>
<p>The variety of different version-suffix for the cosmo-package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">git</span>      <span class="o">=</span> <span class="s1">&#39;ssh://git@github.com/COSMO-ORG/cosmo.git&#39;</span>
<span class="n">apngit</span>   <span class="o">=</span> <span class="s1">&#39;ssh://git@github.com/MeteoSwiss-APN/cosmo.git&#39;</span>
<span class="n">c2smgit</span>  <span class="o">=</span> <span class="s1">&#39;ssh://git@github.com/C2SM-RCM/cosmo.git&#39;</span>

<span class="n">version</span><span class="p">(</span><span class="s1">&#39;org-master&#39;</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="s1">&#39;master&#39;</span><span class="p">,</span> <span class="n">get_full_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">version</span><span class="p">(</span><span class="s1">&#39;apn-mch&#39;</span><span class="p">,</span> <span class="n">git</span><span class="o">=</span><span class="n">apngit</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="s1">&#39;mch&#39;</span><span class="p">,</span> <span class="n">get_full_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">version</span><span class="p">(</span><span class="s1">&#39;c2sm-master&#39;</span><span class="p">,</span> <span class="n">git</span><span class="o">=</span><span class="n">c2smgit</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="s1">&#39;master&#39;</span><span class="p">,</span> <span class="n">get_full_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">version</span><span class="p">(</span><span class="s1">&#39;c2sm-features&#39;</span><span class="p">,</span> <span class="n">git</span><span class="o">=</span><span class="n">c2smgit</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="s1">&#39;c2sm-features&#39;</span><span class="p">,</span> <span class="n">get_full_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">version</span><span class="p">(</span><span class="mf">5.09</span><span class="p">,</span> <span class="n">git</span><span class="o">=</span><span class="n">c2sm</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mf">5.09</span><span class="p">,</span> <span class="n">get_full_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>There are three different git repositories available for the cosmo-package:</p>
<ul class="simple">
<li><p>COSMO-ORG/cosmo.git: version-suffix <em>org-master</em></p></li>
<li><p>MeteoSwiss-APN/cosmo.git: version-suffix <em>apn-mch</em></p></li>
<li><p>C2SM-RCM/cosmo.git: version-suffix <em>c2sm-master</em></p></li>
<li><p>C2SM-RCM/cosmo.git: version-suffix <em>c2sm-features</em></p></li>
</ul>
<p>It is clear that only using <em>spack install &lt;package&gt;&#64;5.09</em> will
always result in the same code, all other version only point to a
<em>HEAD</em> of a git branch.</p>
<p>The list of versions, including tagged versions, is provided by <em>spack
info package_name</em>. Note that tagged versions for COSMO on the
<em>c2sm-features</em> branch are not yet provided but will be offered
soon. We thus recommend using the <em>spack devbuildcosmo</em> command for
now.</p>
<p>So long story short:</p>
<p><strong>Always use a valid git tag as a version-suffix when building
software with</strong> <em>spack install</em> <strong>for production!</strong></p>
</section>
<section id="spack-dev-build-c2sm-guidelines">
<h3>Spack dev-build (C2SM Guidelines)<a class="headerlink" href="#spack-dev-build-c2sm-guidelines" title="Permalink to this heading"></a></h3>
<p>In order to install software with <em>spack dev-build</em> one needs a
local source code.  Spack will compile the code as it is locally
present. Contrary to <em>spack install</em>, version-suffix (&#64;master, &#64;v2.7.9, etc,) does not have
any effect on the code version compiled.
To be safe always use <em>&#64;mdev-build</em> and copy the executable after installation
into the source-folder.</p>
<p>So long story short:</p>
<p><strong>Always store the local sources and the corresponding executable in
the same location!</strong></p>
</section>
</section>
<section id="running">
<h2>Running<a class="headerlink" href="#running" title="Permalink to this heading"></a></h2>
<p>When used properly, Spack is able to manage many different
configurations of a package along with the corresponding
run-environment.</p>
<section id="load-run-environment-of-a-package">
<h3>Load run-environment of a package<a class="headerlink" href="#load-run-environment-of-a-package" title="Permalink to this heading"></a></h3>
<p>Spack provides the command <em>spack load</em> to load the environment
needed to run a binary into your current shell. There are two
different ways of using it and both of them are fine.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>spack load &lt;package&gt;@&lt;version&gt;%&lt;compiler&gt; +&lt;variants&gt;
</pre></div>
</div>
<p>The executable now has the correct environment to run in your current shell.</p>
<p>The other possibility is use <em>spack load</em> to print the required
shell commands and store them in a file that can be sourced at a later
stage:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>spack load --sh &lt;package&gt;@&lt;version&gt;%&lt;compiler&gt; +&lt;variants&gt; &gt; run_package.env
</pre></div>
</div>
<p>An example output of <em>spack load -sh</em> for COSMO could look as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">LIBRARY_PATH</span><span class="o">=</span>/opt/cray/pe/mpt/7.7.15/gni/mpich-pgi/20.1/lib:/project/s903/juckerj/spack-install/daint/eccodes/2.19.0/pgi/ccigv3uvkdl5h3d2jtb6blxvvv4qsdpc/lib64:/apps/daint/UES/xalt/xalt2/software/xalt/2.8.10/lib64:/apps/daint/UES/xalt/xalt2/software/xalt/2.8.10/lib<span class="p">;</span>
<span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/opt/cray/pe/mpt/7.7.15/gni/mpich-pgi/20.1/lib:/project/s903/juckerj/spack-install/daint/eccodes/2.19.0/pgi/ccigv3uvkdl5h3d2jtb6blxvvv4qsdpc/lib64:/opt/cray/pe/gcc-libs:/apps/daint/UES/xalt/xalt2/software/xalt/2.8.10/lib64:/apps/daint/UES/xalt/xalt2/software/xalt/2.8.10/lib:/opt/cray/pe/papi/6.0.0.4/lib64:/opt/cray/job/2.2.4-7.0.2.1_2.86__g36b56f4.ari/lib64<span class="p">;</span>
<span class="nb">export</span> <span class="nv">GRIB_SAMPLES_PATH</span><span class="o">=</span>/project/s903/juckerj/spack-install/daint/cosmo-eccodes-definitions/2.19.0.5/pgi/egf6fp466u2cl3ckkmhpemzf4hz7loqr/cosmoDefinitions/samples<span class="p">;</span>
<span class="nb">export</span> <span class="nv">GRIB_DEFINITION_PATH</span><span class="o">=</span>/project/s903/juckerj/spack-install/daint/cosmo-eccodes-definitions/2.19.0.5/pgi/egf6fp466u2cl3ckkmhpemzf4hz7loqr/cosmoDefinitions/definitions/:/project/s903/juckerj/spack-install/daint/eccodes/2.19.0/pgi/ccigv3uvkdl5h3d2jtb6blxvvv4qsdpc/share/eccodes/definitions<span class="p">;</span>
</pre></div>
</div>
<p><strong>Always load the run-environment provided by Spack prior to any
executions of an executable installed by Spack!</strong></p>
</section>
</section>
<section id="spack-in-scripts">
<h2>Spack in scripts<a class="headerlink" href="#spack-in-scripts" title="Permalink to this heading"></a></h2>
<p>The Spack commands are rather tailored for interacive use. It is for
instance very possible that commands like <em>spack find</em> or <em>spack
location</em> complain about several potential installed <em>SPECS</em> meeting
the command line input. For this reason it’s rather recommended to
avoid spack commands in scripts. This shouldn’t be too problematic for
<em>spack find</em> and <em>spack location</em>. For <em>spack load</em> we rather
advise to use it from the login nodes before submitting jobs, the
environment of the running job being inherited from the environment at
submission time.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="QuickStart.html" class="btn btn-neutral float-left" title="Quick Start" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="InstanceManagement.html" class="btn btn-neutral float-right" title="How to manage your own Spack instance" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, C2SM.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>