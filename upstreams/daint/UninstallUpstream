pipeline {

    agent {
        node {
            label 'daint'
        }
    }
    stages {
            stage('Create environment') {
                steps {
                    sh """
                    python3 -m venv env
                    source env/bin/activate
                    pip install -r requirements.txt
                    """
                }
            }
            stage('Uninstall Upstream Base') {
                steps {
                    sh"""
                    source env/bin/activate
                    python src/upstream.py upstreams/daint/base
                    """
                }
            }
            stage('Uninstall Upstream Icon-DSL') {
                steps {
                    sh"""
                    . ./setup-env.sh
                    spack env activate upstreams/daint/icon-dsl
                    spack uninstall -afy
                    """
                }
            }
            stage('Uninstall Upstream Icon-rttov') {
                steps {
                    sh"""
                    . ./setup-env.sh
                    spack env activate upstreams/daint/icon-rttov
                    spack uninstall -afy
                    """
                }
            }
    }
    post {
        always {
            echo 'Cleaning up workspace'
            deleteDir()
        }
    }

}

