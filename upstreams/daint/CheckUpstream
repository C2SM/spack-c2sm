String[] BuilderList = ['daint_cpu_nvhpc','daint_gpu_nvhpc','daint_gpu_nvhpc_mixed','daint_cpu_nvhpc_mixed','daint_cpu_cce']
pipeline {
    agent {
        node {label 'daint'}
    }
    stages {
        stage('Check upstream installation for ICON') {
            steps {
                script { 
                    for(BUILDER in BuilderList){
                        stage('Clone icon-nwp') {
                            steps {
                                sh"""
                                git clone git@gitlab.dkrz.de:icon/icon-nwp.git ${BUILDER}
                                cd ${BUILDER}
                                git switch spack-envs
                                git submodule update --init --recursive
                                """
                            }
                        }
                        stage('Check completeness for Builder') {
                            steps {
                                sh"""
                                . ./setup-env.sh
                                cd ${BUILDER}
                                spack env activate config/cscs/spack-envs/${BUILDER}
                                spack install --only package --until configure
                                """
                            } 
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            echo 'Cleaning up workspace'
            deleteDir()
        }
    }
}
